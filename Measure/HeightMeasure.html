<!DOCTYPE html>
<!--
create author 路建成
date 2018.3.19
add use strict
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>高度测量</title>
    <script src="../../Build/Cesium/Cesium.js"></script>
    <script src="../js/EditorModule.js"></script>
    <style>
        @import "../css/common.css";
        @import "../../Build/Cesium/Widgets/widgets.css";
    </style>
</head>
<body>
<button id="height">高度测量</button>
<div id="CesiumContainer"></div>

<script>
    'use strict';
    //一定要有terrainProvider
    Cesium.BingMapsApi.defaultKey="Ai50Y21LEk2ZbEcY78R_vXpCk6gZvZ9dxuGoMHppV-nzLuTkfDz1wNt8knbly0zW";
    const viewer=new Cesium.Viewer("CesiumContainer");

    const handler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    viewer.terrainProvider=new Cesium.createWorldTerrain();

    viewer.camera.flyTo({
        destination:Cesium.Cartesian3.fromDegrees(128.956,42.34955,10000),
        duration:5
    });

    document.getElementById('height').onclick=function () {
        handler.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian){
                Globe._cartesian3Array_.push(cartesian);
                if(Globe._entity_!==undefined&&Globe._cartesian3Array_.length===2){
                    viewer.entities.remove(Globe._entity_);
                    Globe._entity_=Editor.addLine(
                        Globe._cartesian3Array_,
                        Globe._cartesian3Array_[parseInt(Globe._cartesian3Array_.length)/2],
                        new Cesium.LabelGraphics({
                            text:calcRelativeHeight(Globe._cartesian3Array_)[0].toFixed(2)+" m ",
                            scale:0.35
                        })
                    );
                    reset();
                    handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
                }else {
                    Globe._entity_=Editor.addPoint(Globe._cartesian3Array_[0]);
                }

            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    };
function calcRelativeHeight(cartesian3Array){
    const wgs84globe=viewer.scene.globe;
    let heightdiff=[];
    for(let i=1;i<cartesian3Array.length;++i){
        let cartographic1=Cesium.Cartographic.fromCartesian(cartesian3Array[i-1]);
        let cartographic2=Cesium.Cartographic.fromCartesian(cartesian3Array[i]);
        heightdiff.push(wgs84globe.getHeight(cartographic1)-wgs84globe.getHeight(cartographic2));
    }
    return heightdiff;
}

</script>
</body>
</html>