
<!DOCTYPE html>
<!--
create author 路建成
date 2018.3.18

fix ，线面没有画完，不会在下一次绘图时消失，且无法清除计算结果
add use strict
simple refactor this page and use EditorModule.js ,MeasureModule.js
to simple package function

-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>点位，长度，面积测量</title>
    <script src="../../Build/Cesium/Cesium.js"></script>
    <script src="../js/EditorModule.js"></script>
    <script src="../js/MeasureModule.js"></script>
    <style>
        @import "../common.css";
        @import "../../Build/Cesium/Widgets/widgets.css";
    </style>
</head>
<body>
<div>
    <button id="point" >点位测量</button>
    <button id="length" >长度测量</button>
    <button id="area" >面积测量</button>
    <button id="clearMeasureData" disabled="disabled">清空计算结果</button>
</div>
<div id="CesiumContainer"></div>

<script>
    'use strict';
    //单独每个功能都已实现， need 整合
    Cesium.BingMapsApi.defaultKey="Ai50Y21LEk2ZbEcY78R_vXpCk6gZvZ9dxuGoMHppV-nzLuTkfDz1wNt8knbly0zW";
    const viewer=new Cesium.Viewer("CesiumContainer");
    //用于点，线，面的创建
    //private var
    //EntityCustomAdd global var
    
    Globe._handler_=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    const projection=new Cesium.WebMercatorProjection();

    //用于成功创建后entity清空用
    var measureEntities=[];
    document.getElementById("point").onclick=function () {
        //设置inputAction
        clearErrorMeasureData();
        Globe._handler_.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian){
                Globe._entity_=Editor.addPoint(cartesian,new Cesium.LabelGraphics({
                    text:Geo2Str(cartesian,2),
                    scale:0.35,
                    pixelOffset:new Cesium.Cartesian2(10,-10)//右上角偏移
                }));
                //加入计算结果中，以便删除
                measureEntities.push(Globe._entity_);
                updateClearMeasureButton();
                reset();
                Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    };
    //采用每个点
    document.getElementById("length").onclick=function () {
        clearErrorMeasureData();
        Globe._handler_.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian){
                Globe._cartesian3Array_.push(cartesian);
                if(Globe._entity_!==undefined){
                    viewer.entities.remove(Globe._entity_);
                    Globe._entity_=Editor.addLine(Globe._cartesian3Array_,Globe._cartesian3Array_[parseInt(Globe._cartesian3Array_.length/2)],new Cesium.LabelGraphics({
                        text:Measure.calcLength(Globe._cartesian3Array_).toFixed(2)+' m',
                        scale:0.35
                    }));
                }else {
                    Globe._entity_=Editor.addPoint(Globe._cartesian3Array_[0]);
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        Globe._handler_.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian&&Globe._entity_!==undefined){
                Globe._cartesian3Array_.push(cartesian);
                viewer.entities.remove(Globe._entity_);
                Globe._entity_=Editor.addLine(Globe._cartesian3Array_,Globe._cartesian3Array_[parseInt(Globe._cartesian3Array_.length/2)],new Cesium.LabelGraphics({
                    text:Measure.calcLength(Globe._cartesian3Array_).toFixed(2)+' m',
                    scale:0.35
                }));
                //加入计算结果中，以便删除
                measureEntities.push(Globe._entity_);
                updateClearMeasureButton();

                reset();
                Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
                Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);

            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK );
    };
    //采用第一个是点，第二个便是线，三+就是面
    document.getElementById("area").onclick=function () {
        clearErrorMeasureData();
        Globe._handler_.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian){
                Globe._cartesian3Array_.push(cartesian);
                if(Globe._entity_!==undefined){
                    viewer.entities.remove(Globe._entity_);
                    if(Globe._cartesian3Array_.length===2){
                        Globe._entity_=Editor.addLine(Globe._cartesian3Array_);
                    }else{
                        Globe._entity_=Editor.addPolygon(
                            new Cesium.PolygonHierarchy(Globe._cartesian3Array_),
                            Globe._cartesian3Array_[parseInt(Globe._cartesian3Array_.length/2)],
                        new Cesium.LabelGraphics({
                            text:Measure.calcArea(Globe._cartesian3Array_).toFixed(2)+' m^2',
                            scale:0.35
                        }));
                    }
                }
                else {
                    Globe._entity_=Editor.addPoint(Globe._cartesian3Array_[0]);
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        Globe._handler_.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian&&Globe._entity_!==undefined){
                Globe._cartesian3Array_.push(cartesian);
                viewer.entities.remove(Globe._entity_);
                Globe._entity_=Editor.addPolygon(
                    new Cesium.PolygonHierarchy(Globe._cartesian3Array_),
                    Globe._cartesian3Array_[parseInt(Globe._cartesian3Array_.length/2)],
                    new Cesium.LabelGraphics({
                        text:Measure.calcArea(Globe._cartesian3Array_).toFixed(2)+' m^2',
                        scale:0.35
                    }));
                //加入计算结果中，以便删除
                measureEntities.push(Globe._entity_);
                updateClearMeasureButton();
                //reset
                reset();
                Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
                Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);

            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK );
    };
    document.getElementById('clearMeasureData').onclick=function () {
        cleanMeasureData();
    };


    //只有在MeasureEntities 不为空时才会点击清空测量结果
    function updateClearMeasureButton() {
        if(measureEntities.length>0){
            document.getElementById('clearMeasureData').removeAttribute('disabled');
        }else{
            document.getElementById('clearMeasureData').setAttribute('disabled','disabled');
        }
    }
    /**
     *将单次画entity清空，以便下次绘画
     */
    function reset() {
        Globe._entity_=undefined;
        Globe._cartesian3Array_=[];
    }
    function clearErrorMeasureData(){
        if(Globe._entity_!==undefined){
            viewer.entities.remove(Globe._entity_);
            reset();
        }
        if(Globe._handler_!==undefined){
            Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
            Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }
    }
    function cleanMeasureData() {
        if(Globe._entity_!==undefined){
            viewer.entities.remove(Globe._entity_);
            reset();
        }
        if(Globe._handler_!==undefined){
            Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
            Globe._handler_.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }
        for(let i=0;i<measureEntities.length;++i){
            viewer.entities.remove(measureEntities[i]);
        }
        measureEntities=[];
    }

    /**
     * 地理坐标以角度字符串输出
     * @param cartesian3 地理坐标
     * @param number 输出的位数，默认为2位
     * @returns {string}
     */
    function Geo2Str(cartesian3,number){
        if(number===undefined)number=2;
        let cartographic=Cesium.Cartographic.fromCartesian(cartesian3);
        //可能需要东西经，南北纬

        let longtitude=Cesium.Math.toDegrees(cartographic.longitude);
        let latitude=Cesium.Math.toDegrees(cartographic.latitude);
        //
        let str='';
        str+=Math.abs(longtitude.toFixed(number));
        if(longtitude>0)
            str+='E';
        else str+='W';
        str+=' '+Math.abs(latitude.toFixed(number));
        if(latitude>0){
            str+='N';
        }else str+='S';
        return str;
    }
</script>
</body>
</html>