<!DOCTYPE html>
<!--
create author 路建成
date 2018.3.16
add use strict
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>距离测量</title>
    <script src="../../Build/Cesium/Cesium.js"></script>
    <style>
        @import "../common.css";
        @import "../../Build/Cesium/Widgets/widgets.css";
    </style>
</head>
<body>

<button id="line">线测量</button>
<div id="CesiumContainer"></div>
<script>
    'use strict';
    /*
    * 长度测量，先得到点的坐标，然后转为Web Mercator投影，两个点以上时计算长度
    * 此测量在地理坐标系下无法进行。因为投影坐标系无法确定
    * */
    Cesium.BingMapsApi.defaultKey="Ai50Y21LEk2ZbEcY78R_vXpCk6gZvZ9dxuGoMHppV-nzLuTkfDz1wNt8knbly0zW";
    const viewer=new Cesium.Viewer("CesiumContainer");
    let handler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    var cartesian3Array=[];
    var entity=undefined;
    const projection=new Cesium.WebMercatorProjection();

    /**
     * 计算线的长度
     * @param cartesian3Points Array
     * @returns {number}
     */
    function calcLength(cartesianPoints) {
        var newarray=[];
        for(let i=0;i<cartesianPoints.length;++i){
            let cartographic=Cesium.Cartographic.fromCartesian(cartesianPoints[i]);
            newarray[i]=projection.project(cartographic);
        }
        var answer=0;
        for(let i=1;i<newarray.length;++i){
            answer+= Math.abs(Cesium.Cartesian3.distanceSquared(newarray[i-1],newarray[i]));
        }
        return answer;
    }
    handler.setInputAction(function (move) {
        let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
        if(cartesian){
            cartesian3Array.push(cartesian);
            if(cartesian3Array.length>=2){
                let len=calcLength(cartesian3Array);
                alert(len.toFixed(2)+ ' m')
            }
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
</script>
</body>
</html>