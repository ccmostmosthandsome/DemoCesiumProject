<!DOCTYPE html>
<!--
create author 路建成
date 2018.2.28
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>点线面的手工绘制添加</title>
    <script src="../Build/Cesium/Cesium.js"></script>
    <style>
        @import "../Build/Cesium/Widgets/widgets.css";
        @import "common.css";
    </style>
</head>
<body>
<div>
    <button id="StartDraw">开始绘制</button>
    <button id="point" disabled="disabled">画 点</button>
    <button id="polyline" disabled="disabled">画 线</button>
    <button id="polygon" disabled="disabled">画 面</button>

</div>
<div id="CesiumContainer"></div>
<script>
    Cesium.BingMapsApi.defaultKey="Ai50Y21LEk2ZbEcY78R_vXpCk6gZvZ9dxuGoMHppV-nzLuTkfDz1wNt8knbly0zW";
    const viewer=new Cesium.Viewer("CesiumContainer");
    let handler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    const node= document.getElementById("StartDraw");
    node.onclick=function () {
        if(node.innerHTML=="开始绘制"){
            document.getElementById("point").removeAttribute("disabled");
            document.getElementById("polyline").removeAttribute("disabled");
            document.getElementById("polygon").removeAttribute("disabled");
            node.innerHTML="停止绘制";
            //cleanErrorEditData();
        }else if(node.innerHTML=="停止绘制"){
            document.getElementById("point").setAttribute("disabled","disabled");
            document.getElementById("polyline").setAttribute("disabled","disabled");
            document.getElementById("polygon").setAttribute("disabled","disabled");
            node.innerHTML="开始绘制";
            cleanErrorEditData();
        }
    };

    var entity=undefined;
    var cartesian3Array=[];
    document.getElementById("point").onclick=function () {
        //设置inputAction
        cleanErrorEditData();
        handler.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            //保持point,polyline,polygon是一致的行为
            if(cartesian){
                entity=addPoint(cartesian);
                reset();
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    };
    //采用每个点
    document.getElementById("polyline").onclick=function () {
        //alert("双击停止绘制");
        cleanErrorEditData();
        handler.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian){
                cartesian3Array.push(cartesian);
                if(entity!==undefined){
                    viewer.entities.remove(entity);
                    entity=addLine(cartesian3Array);
                }
                else {
                    entity=addPoint(cartesian3Array[0]);
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        handler.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian&&entity!==undefined){
                cartesian3Array.push(cartesian);
                viewer.entities.remove(entity);
                entity=addLine(cartesian3Array);
                //reset
                reset();
            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK );
    };
    //采用第一个是点，第二个便是线，三+就是面
    document.getElementById("polygon").onclick=function () {
        //alert("双击停止绘制");
        cleanErrorEditData();
        handler.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian){
                let cartographic=Cesium.Cartographic.fromCartesian(cartesian);
                cartesian3Array.push(Cesium.Cartesian3.fromRadians(cartographic.longitude,cartographic.latitude));
                if(entity!==undefined){
                    viewer.entities.remove(entity);
                    if(cartesian3Array.length===2){
                        entity=addLine(cartesian3Array);
                    }else{
                        entity=viewer.entities.add({
                            polygon:new Cesium.PolygonGraphics({
                                hierarchy:new Cesium.PolygonHierarchy(cartesian3Array)
                            })
                        });
                    }
                }
                else {
                    entity=addPoint(cartesian3Array[0]);
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        handler.setInputAction(function (move) {
            let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
            if(cartesian&&entity!==undefined){
                let cartographic=Cesium.Cartographic.fromCartesian(cartesian);
                cartesian3Array.push(Cesium.Cartesian3.fromRadians(cartographic.longitude,cartographic.latitude));
                viewer.entities.remove(entity);
                entity=viewer.entities.add({
                    polygon:new Cesium.PolygonGraphics({
                        hierarchy:new Cesium.PolygonHierarchy(cartesian3Array)
                    })
                });
                //reset
                reset();
            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK );
    };
    function addLine(positions) {
        return viewer.entities.add({
            polyline:new Cesium.PolylineGraphics({
                positions:positions
            })
        });
    }
    function addPoint(position) {
        return viewer.entities.add({
            position:position,
            point:new Cesium.PointGraphics({
                pixelSize:10
            })
        });
    }
    /**
     *将单次画entity清空，以便下次绘画
     */
    function reset() {
        entity=undefined;
        cartesian3Array=[];
    }
    function cleanErrorEditData() {
        if(entity!==undefined){
            viewer.entities.remove(entity);
            reset();
        }
        if(handler!==undefined){
            handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
            handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }
    }
</script>
</body>
</html>