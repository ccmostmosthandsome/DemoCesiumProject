<!DOCTYPE html>
<!--
create author 路建成
date 2018.3.1
this is 各个demo的合并版
但点线面选择会不如单文件版
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>所有demo 集成到一块</title>
    <script src="../Build/Cesium/Cesium.js"></script>
    <style>
        @import "common.css";
        @import "../Build/Cesium/Widgets/widgets.css";
        #toolbar{
            font-family: "Consolas", monospace;
            height: 10%;
        }
        .space{
            width:5em;
            height: 1em;
        }
        #toolbar div{
            float:left;
        }
        div.showBorder{
            border-style: solid;
            border-color:black;
            border-width: 1px;
        }
    </style>
</head>
<body>

<div id="toolbar">
    <div class="space"></div>
    <div class="showBorder">
        <p>飞行定位</p>
        <button id="flyToImpl1">飞行定位实现1</button>
        <button id="flyToImpl2">飞行定位实现2</button>
    </div>
    <div class="space"></div>
    <div id="GraphicAdd" class="showBorder">
        <p>要素添加</p>
        <button id="StartDraw">开始绘制</button>
        <button id="point" disabled="disabled">画 点</button>
        <button id="polyline" disabled="disabled">画 线</button>
        <button id="polygon" disabled="disabled">画 面</button>
    </div>
    <div class="space">    </div>
    <div id="GraphicShowHide" class="showBorder">
        <p>要素显隐</p>
        点显示<input type="checkbox" name="Point" checked="checked">
        线显示<input type="checkbox" name="Polyline" checked="checked">
        面显示<input type="checkbox" name="Polygon" checked="checked">
    </div>
</div>
<div id="CesiumContainer"></div>
<script>
    //全局高亮设置
    const HIGHTLIGHTCOLOR=Cesium.Color.RED;
    Cesium.BingMapsApi.defaultKey="Ai50Y21LEk2ZbEcY78R_vXpCk6gZvZ9dxuGoMHppV-nzLuTkfDz1wNt8knbly0zW";
    const viewer=new Cesium.Viewer("CesiumContainer",{
        infobox:false,
        selectionIndicator:false
    });

    InitEntityCustomAddFunction();
    InitEntityCategoryShowHide();
    InitFlyToFunction();
    InitEntitySelect();


    //init
    function InitFlyToFunction() {
        //binding event
        document.getElementById("flyToImpl1").onclick=function () {
            alert("将定位到预定义的box位置");
            let box=viewer.entities.add({
                //id不能重复
                //id:"testentity",
                name:"box",
                position:Cesium.Cartesian3.fromDegrees(100,40,1000),
                box:new Cesium.BoxGraphics({
                    dimensions:new Cesium.Cartesian3(1000,2000,3000),
                    material:new Cesium.ColorMaterialProperty(Cesium.Color.RED),
                    shadows:Cesium.ShadowMode.ENABLE
                })
            });
            //impl1
            viewer.flyTo(box,{
                maximumHeight:50000,
                duration:5
            });
        };
        document.getElementById("flyToImpl2").onclick=function () {
            //impl2
            alert("将定位到90 W,30 N 2000 H位置");
            viewer.camera.flyTo({
                destination:Cesium.Cartesian3.fromDegrees(90,30,2000),
                duration:5
            });

        }

    }
    function InitEntityCustomAddFunction() {
        const node= document.getElementById("StartDraw");
        node.onclick=function () {
            if(node.innerHTML=="开始绘制"){
                document.getElementById("point").removeAttribute("disabled");
                document.getElementById("polyline").removeAttribute("disabled");
                document.getElementById("polygon").removeAttribute("disabled");
                node.innerHTML="停止绘制";
                //cleanErrorEditData();
            }else if(node.innerHTML=="停止绘制"){
                document.getElementById("point").setAttribute("disabled","disabled");
                document.getElementById("polyline").setAttribute("disabled","disabled");
                document.getElementById("polygon").setAttribute("disabled","disabled");
                node.innerHTML="开始绘制";
                cleanErrorEditData();
            }

            document.getElementById("point").onclick=function () {
                //设置inputAction
                cleanErrorEditData();
                handler.setInputAction(function (move) {
                    let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
                    //保持point,polyline,polygon是一致的行为
                    if(cartesian){
                        entity=addPoint(cartesian);
                        reset();
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
            };
            //采用每个点
            document.getElementById("polyline").onclick=function () {
                //alert("双击停止绘制");
                cleanErrorEditData();
                handler.setInputAction(function (move) {
                    let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
                    if(cartesian){
                        cartesian3Array.push(cartesian);
                        if(entity!==undefined){
                            viewer.entities.remove(entity);
                            entity=addLine(cartesian3Array);
                        }
                        else {
                            entity=addPoint(cartesian3Array[0]);
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
                handler.setInputAction(function (move) {
                    let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
                    if(cartesian&&entity!==undefined){
                        cartesian3Array.push(cartesian);
                        viewer.entities.remove(entity);
                        entity=addLine(cartesian3Array);
                        //reset
                        reset();
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK );
            };
            //采用第一个是点，第二个便是线，三+就是面
            document.getElementById("polygon").onclick=function () {
                //alert("双击停止绘制");
                cleanErrorEditData();
                handler.setInputAction(function (move) {
                    let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
                    if(cartesian){
                        cartesian3Array.push(cartesian);
                        if(entity!==undefined){
                            viewer.entities.remove(entity);
                            if(cartesian3Array.length===2){
                                entity=addLine(cartesian3Array);
                            }else{
                                entity=viewer.entities.add({
                                    polygon:new Cesium.PolygonGraphics({
                                        hierarchy:new Cesium.PolygonHierarchy(cartesian3Array)
                                    })
                                });
                            }
                        }
                        else {
                            entity=addPoint(cartesian3Array[0]);
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
                handler.setInputAction(function (move) {
                    let cartesian=viewer.camera.pickEllipsoid(move.position,viewer.scene.globe.ellipsoid);
                    if(cartesian&&entity!==undefined){
                        cartesian3Array.push(cartesian);
                        viewer.entities.remove(entity);
                        entity=viewer.entities.add({
                            polygon:new Cesium.PolygonGraphics({
                                hierarchy:new Cesium.PolygonHierarchy(cartesian3Array)
                            })
                        });
                        //reset
                        reset();
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK );
            };

        };
    }
    function InitEntityCategoryShowHide() {
        //binding event
        let nodes=document.querySelectorAll("#GraphicShowHide input");
        for(let i=0;i<nodes.length;++i){
            nodes.item(i).addEventListener("click",function (evt) {
                console.log(evt);
                let str=evt.target.name;
                processShowHide(str,evt.target.checked,viewer.entities.values);
            });
        }
    }
    function InitEntitySelect() {

        viewer.screenSpaceEventHandler.setInputAction(function leftClick(click) {
            let pick=viewer.scene.pick(click.position);
            //判断
            if(pick==undefined){
                //遍历容器内的entity,恢复默认值
                let entities=viewer.entities.values;
                for(let i=0;i<entities.length;++i){
                    processSelect(entities[i],Cesium.Color.WHITE);
                }
            }
            else{
                processSelect(pick.id,HIGHTLIGHTCOLOR);
                //print info
                console.log(pick.id);
                //alert(pick.id.attributes.data);
            }

        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    }

    //EntityCustomAdd global var
    var entity=undefined;
    var cartesian3Array=[];
    let handler=new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    //EntityCustomAdd use
    function addLine(positions) {
        return viewer.entities.add({
            polyline:new Cesium.PolylineGraphics({
                positions:positions
            })
        });
    }
    function addPoint(position) {
        return viewer.entities.add({
            position:position,
            point:new Cesium.PointGraphics({
                pixelSize:10
            })
        });
    }
    function reset() {
        entity=undefined;
        cartesian3Array=[];
    }
    function cleanErrorEditData() {
        if(entity!==undefined){
            viewer.entities.remove(entity);
            reset();
        }
        if(handler!==undefined){
            handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
            handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }
    }

    //EntityCategoryShowHide use
    /**
     * 控制entity显隐 此版本假设集合内为乱序，Point,Polygon,Polygon
     * @param graphicName entity的category name PointGraphics->Point
     * @param isShow
     * @param entities Array 要控制entity集合
     */
    function processShowHide(graphicName,isShow,entities) {
        if(entities==undefined||entities.length==0)return;

        for(let i=0;i<entities.length;++i){
            if(graphicName==="Point"){
                if(entities[i].point!==undefined){
                    entities[i].show=isShow;
                }
            }else if(graphicName==="Polyline"){
                if(entities[i].polyline!==undefined){
                    entities[i].show=isShow;
                }
            }else if(graphicName==="Polygon"){
                if(entities[i].polygon!==undefined){
                    entities[i].show=isShow;
                }
            }
        }
    }
    function processShowHideEffcient(graphicName,isShow,entities) {
        if(entities==undefined||entities.length==0)return;
        //find first polyline and polygon entity index,
        let count=[0,0,0];
        for(let i=0;i<entities.length;++i){
            if(entities[i].point!==undefined){
                count[0]++;
            }
            else if(entities[i].polyline!==undefined){
                count[1]++;
            }
            else if(entities[i].polygon!==undefined){
                count[2]++;
            }
        }
        if(graphicName==="Point"){
            for(let i=0;i<count[0];++i){
                entities[i].show=isShow;
            }
        }else if(graphicName==="Polyline"){
            for(let i=count[0];i<count[1]+count[0];++i){
                entities[i].show=isShow;
            }
        }else if(graphicName==="Polygon"){
            for(let i=count[1]+count[0];i<entities.length;++i){
                entities[i].show=isShow;
            }
        }
    }
    /*
    此函数假定一个entity只有一个graphic
    * */
    function processSelect(entity,color) {
        if(entity==undefined)return;
        if(entity.point!==undefined){
            entity.point.color=color;
        }else if(entity.polyline!==undefined){
            entity.polyline.material=color;
        }else if(entity.polygon!==undefined){
            entity.polygon.material=color;
        }
        /*
        else if(entity.rectangle!==undefined){
            entity.rectangle.material=color;
        }else if(entity.wall!==undefined){
            entity.wall.material=color;
        }else if(entity.plane!==undefined){
            entity.plane.material=color;
        }else if(entity.path!==undefined){
            entity.path.material=color;
        }else if(entity.model!==undefined){
            entity.model.color=color;
        }else if(entity.label!==undefined){
            entity.label.fillColor=color;
        }else if(entity.ellipsoid!==undefined){
            entity.ellipsoid.material=color;
        }else if(entity.ellipse!==undefined){
            entity.ellipse.material=color;
        }else if(entity.cylinder!==undefined){
            entity.cylinder.material=color;
        }else if(entity.corridor!==undefined){
            entity.corridor.material=color;
        }else if(entity.box!==undefined){
            entity.box.material=color;
        }else if(entity.billboard!==undefined){
            entity.billboard.material=color;
        }else if(entity.polylineVolume!==undefined){
            entity.polylineVolume.material=color;
        }
        */
    }
</script>
</body>
</html>